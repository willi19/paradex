aruco
=====

.. py:module:: aruco

.. autoapi-nested-parse::

   ArUco and CharUco marker detection module.

   This module provides functions for detecting and tracking ArUco and CharUco markers
   in images from multi-camera systems. Supports multiple dictionary types and
   multi-board CharUco detection.







Module Contents
---------------

.. py:data:: aruco_type
   :value: ['4X4_50', '4X4_100', '4X4_250', '4X4_1000', '5X5_50', '5X5_100', '5X5_250', '5X5_1000',...


.. py:data:: aruco_dict

.. py:data:: arucoDetector_dict

.. py:function:: detect_aruco(img, dict_type='6X6_1000') -> Tuple[List[numpy.ndarray], numpy.ndarray]

   Detect ArUco markers in an image.

   :param img: Input image in BGR format. Shape (H, W, 3) or (H, W).
   :type img: np.ndarray
   :param dict_type: ArUco dictionary type.
                     Supported: '4X4_50' to '7X7_1000'. Defaults to '6X6_1000'.
   :type dict_type: str, optional

   :returns:     - corners: List of detected marker corners. Each element is (4, 2) float32 array.
                 - IDs: Detected marker IDs. Shape (N, 1) int32 array. None if no markers detected.
   :rtype: Tuple[List[np.ndarray], np.ndarray]

   .. rubric:: Example

   >>> corners, ids = detect_aruco(image, dict_type='6X6_1000')
   >>> print(f"Detected {len(corners)} markers")


.. py:function:: check_boardinfo_valid(boardinfo)

   Validate CharUco board information dictionary.

   :param boardinfo: Board configuration dictionary.
   :type boardinfo: Dict[int, Dict]

   :raises AssertionError: If required fields are missing.

   .. note::

      Required fields for each board: 'dict_type', 'numX', 'numY',
      'checkerLength', 'markerLength', 'markerIDs'.


.. py:function:: merge_charuco_detection(detection_list, boardinfo)

   Merge detection results from multiple CharUco boards into a single coordinate system.

   :param detection_list: Detection results per board.
                          Each entry contains 'checkerCorner' and 'checkerIDs'.
   :type detection_list: Dict[int, Dict]
   :param boardinfo: Board configuration dictionary.
   :type boardinfo: Dict[int, Dict]

   :returns:

             Merged detection results containing:
                 - 'checkerCorner': All detected corners. Shape (M, 2).
                 - 'checkerIDs': Corresponding corner IDs with offsets applied. Shape (M, 1).
   :rtype: Dict[str, np.ndarray]

   .. note::

      Corner IDs are offset based on board index to avoid ID collisions.
      Offset for each board = (numX-1) * (numY-1) * board_index.


.. py:function:: detect_charuco(img, boardinfo)

   Detect CharUco board corners and ArUco markers from multiple boards in an image.

   :param img: Input image containing CharUco boards. Shape (H, W, 3) or (H, W).
   :type img: np.ndarray
   :param boardinfo: Dictionary of board configurations. Each board must contain:

                     * 'dict_type' (str): ArUco dictionary type (e.g., '6X6_1000')
                     * 'numX' (int): Number of squares in X direction
                     * 'numY' (int): Number of squares in Y direction
                     * 'checkerLength' (float): Checker square side length (meters)
                     * 'markerLength' (float): ArUco marker side length (meters)
                     * 'markerIDs' (List[int]): List of marker IDs used in the board
   :type boardinfo: Dict[int, Dict]

   :returns:

             Detection results per board ID containing:

                 * 'checkerCorner' (np.ndarray): Detected corner positions. Shape (M, 1, 2).
                 * 'checkerIDs' (np.ndarray): Detected corner IDs. Shape (M, 1).
   :rtype: Dict[int, Dict]

   .. rubric:: Example

   >>> boardinfo = {
   ...     0: {
   ...         'dict_type': '6X6_1000',
   ...         'numX': 10,
   ...         'numY': 7,
   ...         'checkerLength': 0.025,
   ...         'markerLength': 0.0185,
   ...         'markerIDs': list(range(35))
   ...     }
   ... }
   >>> detections = detect_charuco(image, boardinfo)


.. py:function:: draw_charuco(image, corners, color=(0, 255, 255), radius=4, thickness=2, ids=None)

   Draw detected CharUco corners on an image.

   :param image: Image to draw on. Modified in-place.
   :type image: np.ndarray
   :param corners: Corner positions to draw. Shape (M, 2).
   :type corners: np.ndarray
   :param color: BGR color. Defaults to (0, 255, 255) cyan.
   :type color: Tuple[int, int, int], optional
   :param radius: Circle radius in pixels. Defaults to 4.
   :type radius: int, optional
   :param thickness: Circle line thickness. Defaults to 2.
   :type thickness: int, optional
   :param ids: Corner IDs to display as text. Shape (M,). Defaults to None.
   :type ids: np.ndarray, optional

   .. note:: Image is modified in-place. No return value.


.. py:function:: draw_aruco(img, kypt, ids=None, color=(255, 0, 0))

   Draw detected ArUco markers on an image with corner indices.

   :param img: Image to draw on.
   :type img: np.ndarray
   :param kypt: List of marker corners. Each element shape (4, 2).
   :type kypt: List[np.ndarray]
   :param ids: Marker IDs to display. Shape (N,). Defaults to None.
   :type ids: np.ndarray, optional
   :param color: BGR color for corners. Defaults to (255, 0, 0) blue.
   :type color: Tuple[int, int, int], optional

   :returns: Image with drawn markers.
   :rtype: np.ndarray

   .. note::

      Each corner is numbered 0-3 and drawn as a colored circle.
      Marker ID is displayed at the center if provided.


.. py:function:: draw_keypoint(img, kypt, color=(255, 0, 0))

   Draw keypoints as small circles on an image.

   :param img: Image to draw on. Modified in-place.
   :type img: np.ndarray
   :param kypt: Keypoint coordinates. Shape (2,) or (N, 2).
   :type kypt: np.ndarray
   :param color: BGR color. Defaults to (255, 0, 0) blue.
   :type color: Tuple[int, int, int], optional

   :returns: Image with drawn keypoints.
   :rtype: np.ndarray

   .. note:: Single point or multiple points can be provided.


.. py:function:: triangulate_marker(img_dict, intrinsic, extrinsic, dict_type='6X6_1000')

   Triangulate 3D positions of ArUco markers from multiple camera views.

   :param img_dict: Dictionary mapping camera serial numbers to images.
   :type img_dict: Dict[str, np.ndarray]
   :param intrinsic: Camera intrinsic parameters for each serial number.
                     Each entry must contain 'original_intrinsics', 'dist_params', 'intrinsics_undistort'.
   :type intrinsic: Dict[str, Dict]
   :param extrinsic: Camera extrinsic parameters (3x4 or 4x4 matrices).
   :type extrinsic: Dict[str, np.ndarray]
   :param dict_type: ArUco dictionary type. Defaults to '6X6_1000'.
   :type dict_type: str, optional

   :returns:

             Dictionary mapping marker IDs to 3D positions.
                 Each position is shape (1, 3) in world coordinates.
   :rtype: Dict[int, np.ndarray]

   .. rubric:: Example

   >>> img_dict = {'cam_01': img1, 'cam_02': img2}
   >>> marker_3d = triangulate_marker(img_dict, intrinsics, extrinsics)
   >>> print(f"Marker 5 position: {marker_3d[5]}")

   .. note::

      - Images are automatically undistorted before detection
      - Uses RANSAC triangulation for robustness
      - Markers must be visible in at least 2 cameras


